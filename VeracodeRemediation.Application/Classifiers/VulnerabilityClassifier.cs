using System.Text.RegularExpressions;
using VeracodeRemediation.Core.Interfaces;
using VeracodeRemediation.Core.Models;

namespace VeracodeRemediation.Application.Classifiers;

/// <summary>
/// Classifies vulnerabilities as auto-fixable or requiring manual review
/// </summary>
public class VulnerabilityClassifier : IVulnerabilityClassifier
{
    // Auto-fixable CWE patterns (Low/Medium severity, deterministic fixes)
    private static readonly HashSet<string> AutoFixableCwes = new()
    {
        "CWE-89",   // SQL Injection
        "CWE-78",   // OS Command Injection
        "CWE-79",   // XSS
        "CWE-327",  // Use of a Broken or Risky Cryptographic Algorithm
        "CWE-798",  // Use of Hard-coded Credentials
        "CWE-259",  // Use of Hard-coded Password
        "CWE-311",  // Missing Encryption of Sensitive Data
        "CWE-20",   // Improper Input Validation
        "CWE-476",  // NULL Pointer Dereference
        "CWE-502",  // Deserialization of Untrusted Data
    };

    // High severity or architectural issues that should NOT be auto-fixed
    private static readonly HashSet<string> ManualReviewCwes = new()
    {
        "CWE-287",  // Improper Authentication
        "CWE-306",  // Missing Authentication for Critical Function
        "CWE-862",  // Missing Authorization
        "CWE-863",  // Incorrect Authorization
        "CWE-284",  // Improper Access Control
    };

    // Severity thresholds
    private static readonly HashSet<string> LowMediumSeverity = new() { "1", "2", "3", "4", "5", "LOW", "MEDIUM", "Low", "Medium" };

    public bool CanAutoFix(Vulnerability vulnerability)
    {
        // Must have a CWE ID
        if (string.IsNullOrWhiteSpace(vulnerability.CweId))
            return false;

        // Must be low or medium severity
        if (!IsLowOrMediumSeverity(vulnerability.Severity))
            return false;

        // Must not be in manual review list
        if (ManualReviewCwes.Contains(vulnerability.CweId))
            return false;

        // Must be in auto-fixable list OR be a dependency vulnerability (SCA)
        if (AutoFixableCwes.Contains(vulnerability.CweId))
            return true;

        // SCA vulnerabilities with fixed versions can be auto-fixed
        if (vulnerability.IssueType == "SCA" && !string.IsNullOrWhiteSpace(vulnerability.FixedVersion))
            return true;

        // Must have file path for SAST fixes
        if (vulnerability.IssueType == "SAST" && string.IsNullOrWhiteSpace(vulnerability.FilePath))
            return false;

        return false;
    }

    public string GetClassificationReason(Vulnerability vulnerability)
    {
        if (string.IsNullOrWhiteSpace(vulnerability.CweId))
            return "Missing CWE ID";

        if (!IsLowOrMediumSeverity(vulnerability.Severity))
            return $"High/Critical severity ({vulnerability.Severity}) requires manual review";

        if (ManualReviewCwes.Contains(vulnerability.CweId))
            return $"{vulnerability.CweId} involves authentication/authorization logic requiring manual review";

        if (AutoFixableCwes.Contains(vulnerability.CweId))
            return $"Auto-fixable: {vulnerability.CweId}";

        if (vulnerability.IssueType == "SCA" && !string.IsNullOrWhiteSpace(vulnerability.FixedVersion))
            return "SCA vulnerability with available fixed version";

        if (vulnerability.IssueType == "SAST" && string.IsNullOrWhiteSpace(vulnerability.FilePath))
            return "Missing file path for SAST vulnerability";

        return "Not in auto-fixable CWE list";
    }

    private static bool IsLowOrMediumSeverity(string severity)
    {
        if (string.IsNullOrWhiteSpace(severity))
            return false;

        var normalized = severity.Trim();
        return LowMediumSeverity.Contains(normalized) || 
               int.TryParse(normalized, out var num) && num <= 5;
    }
}

