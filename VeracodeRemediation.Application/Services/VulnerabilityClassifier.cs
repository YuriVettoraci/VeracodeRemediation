using VeracodeRemediation.Core.Entities;
using VeracodeRemediation.Core.Interfaces;

namespace VeracodeRemediation.Application.Services;

public class VulnerabilityClassifier : IVulnerabilityClassifier
{
    // CWE IDs that are typically auto-fixable
    private static readonly HashSet<string> AutoFixableCwes = new()
    {
        "CWE-89",  // SQL Injection
        "CWE-78",  // OS Command Injection
        "CWE-79",  // XSS (Cross-site Scripting) - some cases
        "CWE-798", // Hard-coded Credentials
        "CWE-259", // Hard-coded Password
        "CWE-327", // Use of a Broken or Risky Cryptographic Algorithm
        "CWE-328", // Reversible One-Way Hash
        "CWE-330", // Use of Insufficiently Random Values
        "CWE-352", // Cross-Site Request Forgery (CSRF) - some cases
        "CWE-434", // Unrestricted Upload of File with Dangerous Type
        "CWE-502", // Deserialization of Untrusted Data
        "CWE-601", // URL Redirection to Untrusted Site
    };

    // CWE IDs that should NOT be auto-fixed
    private static readonly HashSet<string> NonAutoFixableCwes = new()
    {
        "CWE-287", // Improper Authentication
        "CWE-306", // Missing Authentication for Critical Function
        "CWE-307", // Improper Restriction of Excessive Authentication Attempts
        "CWE-798", // Hard-coded Credentials (handled separately)
        "CWE-311", // Missing Encryption of Sensitive Data
        "CWE-326", // Inadequate Encryption Strength
    };

    public bool IsAutoFixable(Vulnerability vulnerability)
    {
        // High/Critical severity should not be auto-fixed
        if (vulnerability.Severity == "High" || vulnerability.Severity == "Critical")
        {
            vulnerability.AutoFixReason = "High/Critical severity requires manual review";
            return false;
        }

        // SCA vulnerabilities (dependency updates) are generally auto-fixable
        if (vulnerability.VulnerabilityType == "SCA" && 
            !string.IsNullOrEmpty(vulnerability.FixedVersion))
        {
            vulnerability.AutoFixReason = "SCA dependency update available";
            vulnerability.IsAutoFixable = true;
            return true;
        }

        // Check CWE-based rules
        if (NonAutoFixableCwes.Contains(vulnerability.CweId))
        {
            vulnerability.AutoFixReason = $"CWE {vulnerability.CweId} requires manual review";
            return false;
        }

        // Must have file path for SAST fixes
        if (vulnerability.VulnerabilityType == "SAST" && string.IsNullOrEmpty(vulnerability.FilePath))
        {
            vulnerability.AutoFixReason = "No file path available for SAST finding";
            return false;
        }

        // Check if CWE is in auto-fixable list
        if (AutoFixableCwes.Contains(vulnerability.CweId))
        {
            vulnerability.AutoFixReason = $"CWE {vulnerability.CweId} is auto-fixable";
            vulnerability.IsAutoFixable = true;
            return true;
        }

        // Default: not auto-fixable
        vulnerability.AutoFixReason = "CWE not in auto-fixable list or requires manual review";
        return false;
    }

    public string GetFixStrategy(Vulnerability vulnerability)
    {
        if (vulnerability.VulnerabilityType == "SCA")
        {
            return "dependency-upgrade";
        }

        return vulnerability.CweId switch
        {
            "CWE-89" => "sql-injection-parameterize",
            "CWE-78" => "command-injection-sanitize",
            "CWE-798" or "CWE-259" => "hardcoded-secret-env-var",
            "CWE-327" or "CWE-328" => "crypto-algorithm-upgrade",
            "CWE-79" => "xss-encode-output",
            "CWE-434" => "file-upload-validation",
            "CWE-502" => "deserialization-safe",
            "CWE-601" => "url-redirection-whitelist",
            _ => "manual-review"
        };
    }
}

